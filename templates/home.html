<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - CSV Viewer</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: #1f1f1f;
            padding: 20px;
            box-sizing: border-box;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #444;
            overflow-y: auto;
            transition: width 0.3s, padding 0.3s;
        }

        .sidebar.collapsed {
            width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }

        #toggleSidebarButton {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 200;
            background-color: #333;
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #toggleSidebarButton:hover {
            background-color: #444;
        }

        .sidebar h3 {
            margin-bottom: 20px;
            color: #fff;
        }

        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }

        .sidebar ul li {
            margin-bottom: 15px;
            color: #ccc;
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        h2 {
            color: #fff;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .styled-table-container {
            max-width: 100%;
            overflow-x: auto;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 8px;
        }

        .styled-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 25px 0;
            font-size: 0.9em;
            min-width: 600px;
            background-color: #2a2a2a;
            border-radius: 8px;
        }

        .styled-table thead {
            position: sticky;
            top: 0;
            z-index: 3;
        }

        .styled-table th {
            position: sticky;
            top: 0;
            background-color: #333;
            z-index: 3;
            padding: 12px 15px;
            border: 1px solid #444;
            cursor: pointer;
            text-align: left;
            color: #fff;
        }

        .styled-table td {
            padding: 12px 15px;
            border: 1px solid #444;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            max-width: 150px;
            color: #fff;
        }

        .styled-table tbody tr:nth-child(4n+1) {
            background-color: #2a2a2a;
        }

        .styled-table tbody tr:nth-child(4n+2) {
            background-color: #333;
        }

        .styled-table tbody tr:nth-child(4n+3) {
            background-color: #3b3b3b;
        }

        .styled-table tbody tr:nth-child(4n+4) {
            background-color: #444;
        }

        .styled-table tbody tr:hover {
            background-color: #575757 !important;
        }

        .styled-table tbody tr:hover td:first-child {
            background-color: #575757 !important;
        }

        .tooltip {
            position: absolute;
            background-color: #444;
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9em;
            display: none;
            max-width: 300px;
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
            position: relative;
        }

        .filter-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #fff;
            font-size: 0.9em;
        }

        .filter-item {
            margin-bottom: 15px;
        }

        .filter-item label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 0.8em;
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 8px;
            background-color: #333;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .filter-item select[multiple] {
            height: 150px; /* Aumentado para melhor proporção */
        }

        .filter-item select option {
            padding: 4px;
        }

        .apply-filters-btn {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s;
        }

        .apply-filters-btn:hover {
            background-color: #45a049;
        }

        .reset-filters-btn {
            width: 100%;
            padding: 10px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .reset-filters-btn:hover {
            background-color: #da190b;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .content {
                padding: 10px;
            }

            .styled-table td {
                padding: 10px;
                font-size: 0.8em;
            }
        }

        .suggestions {
            max-height: 200px;
            overflow-y: auto;
            background-color: #333;
            border: 1px solid #444;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }

        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            color: #ccc;
        }

        .suggestion-item:hover {
            background-color: #444;
        }

        .copy-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 0.8em;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .copy-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        td:hover .copy-button {
            opacity: 1;
        }

    .pagination {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 15px;
    }

    .pagination a {
        padding: 8px 12px;
        background-color: #333;
        color: #fff;
        text-decoration: none;
        border-radius: 4px;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
    }

    .pagination a:hover {
        background-color: #444;
    }

    .page-control {
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: #2a2a2a;
        padding: 8px 12px;
        border-radius: 4px;
    }

    #pageInput {
        width: 60px;
        padding: 8px;
        background-color: #333;
        border: 1px solid #444;
        color: #fff;
        border-radius: 4px;
        text-align: center;
        -moz-appearance: textfield;
    }

    #pageInput::-webkit-outer-spin-button,
    #pageInput::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

        .copy-feedback {
            position: fixed;
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9em;
            display: none;
            z-index: 1000;
            pointer-events: none;
            animation: fadeOut 1.5s ease-in 0.5s;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .active-filters {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
        }

        .active-filters h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #fff;
            font-size: 0.9em;
        }

        .active-filter-item {
            display: inline-flex;
            align-items: center;
            background-color: #333;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .active-filter-item span {
            margin-right: 8px;
        }

        .remove-filter-btn {
            background: none;
            border: none;
            color: #ff6666;
            cursor: pointer;
            padding: 0;
            margin-left: 5px;
            font-weight: bold;
        }

        .remove-filter-btn:hover {
            color: #ff4444;
        }
        .sheet-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #444;
        }

        .sheet-tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #333;
            color: #fff;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
            transition: background-color 0.3s;
        }

        .sheet-tab.active {
            background-color: #4CAF50;
        }

        .sheet-tab:hover {
            background-color: #555;
        }
        .highlighted {
    background-color: yellow !important;
    color: black !important; /* Para garantir que o texto seja visível */
}
    </style>
</head>
<body>
    <div class="sidebar">
    <h3>Filtros</h3>
    <div class="active-filters">
        <h4>Filtros Ativos</h4>
        <div id="active-filters-list"></div>
    </div>
    <div id="filters-container">
        <!-- Filtro de Valor Deferido permanece fixo -->
        <div class="filter-section" id="valor-deferido-filter">
            <h4>Valor Deferido</h4>
            <div class="filter-item">
                <label>Valor Inicial:</label>
                <input type="text" id="valor-deferido-min" class="currency-input" placeholder="Ex: 1.000,50">
            </div>
            <div class="filter-item">
                <label>Valor Final:</label>
                <input type="text" id="valor-deferido-max" class="currency-input" placeholder="Ex: 5.000,75">
            </div>
        </div>
        <!-- Outros filtros serão adicionados dinamicamente aqui -->
    </div>
    <button class="apply-filters-btn" onclick="applyFilters()">Aplicar Filtros</button>
    <button class="reset-filters-btn" onclick="resetFilters()">Resetar Filtros</button>
</div>

    <div class="content">
        <h2>Guilherme Grummt Wolf</h2>
        <div class="sheet-tabs">
            <div class="sheet-tab active" id="TJPR" onclick="switchSheet('TJPR')">TJPR</div>
            <div class="sheet-tab" id="TJSC" onclick="switchSheet('TJSC')">TJSC</div>
            <div class="sheet-tab" id="TJRS" onclick="switchSheet('TJRS')">TJRS</div>
        </div>
        <div class="styled-table-container">
            <table id="dynamic-table" class="styled-table">
                {{ table_html | safe }}
            </table>
        </div>

        <div class="pagination">
            {% set total_pages = (total // page_size) + (1 if total % page_size > 0 else 0) %}

            {% if page > 1 %}
                <a href="{{ url_for('home', page=1, page_size=page_size) }}" title="Primeira página">««</a>
            {% endif %}

            {% if page > 1 %}
                <a href="{{ url_for('home', page=page-1, page_size=page_size) }}" title="Página anterior">«</a>
            {% endif %}

            <div class="page-control">
                <span>Página</span>
                <input type="number"
                       id="pageInput"
                       min="1"
                       max="{{ total_pages }}"
                       value="{{ page }}"
                       onchange="goToPage(this.value)">
                <span>de {{ total_pages }}</span>
            </div>

            {% if page < total_pages %}
                <a href="{{ url_for('home', page=page+1, page_size=page_size) }}" title="Próxima página">»</a>
            {% endif %}

            {% if page < total_pages %}
                <a href="{{ url_for('home', page=total_pages, page_size=page_size) }}" title="Última página">»»</a>
            {% endif %}
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>
    <div class="loading" id="loading">Carregando...</div>

    <script>
        async function switchSheet(sheetName) {
    try {
        const response = await fetch(`/switch_sheet/${sheetName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
                // Atualizar a classe ativa das abas
                document.querySelectorAll('.sheet-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById(sheetName).classList.add('active');

                // Recarregar os filtros
                await loadFilters();

                // Aplicar os filtros padrão (sem filtros ativos)
                resetFilters();
            }
        } else {
            console.error('Erro ao alternar aba:', await response.text());
        }
    } catch (error) {
        console.error('Erro ao alternar aba:', error);
    }
}
 function formatCurrency(input) {
    const cursorPosition = input.selectionStart;
    let value = input.value.replace(/[^\d,]/g, '');

    // Separar parte inteira e decimal
    let [integerPart, decimalPart = ''] = value.split(',');

    // Formatar parte inteira com separadores
    integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    // Limitar decimal a 2 dígitos
    decimalPart = decimalPart.substring(0, 2);

    // Montar novo valor
    let newValue = integerPart;
    if (decimalPart.length > 0) newValue += `,${decimalPart}`;

    // Atualizar valor mantendo a posição do cursor
    input.value = newValue;

    // Ajustar posição do cursor
    const diff = newValue.length - input.value.length;
    input.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
}

function addThousandSeparators(numberStr) {
    return numberStr.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function setupCurrencyInputs() {
    document.querySelectorAll('.currency-input').forEach(input => {
        // Adicionar símbolo R$
        const symbol = document.createElement('span');
        symbol.className = 'currency-symbol';
        symbol.textContent = ' ';
        input.parentNode.appendChild(symbol);

        // Event listeners
        input.addEventListener('input', (e) => {
            formatCurrency(e.target);
            e.target.dispatchEvent(new Event('change')); // Disparar evento de mudança
        });

        // Converter para valor numérico em data-attribute
        input.addEventListener('change', (e) => {
            const numericValue = parseFloat(
                e.target.value.replace(/\./g, '').replace(',', '.')
            ) || 0;
            e.target.dataset.numericValue = numericValue;
        });
    });
}

let activeFilters = {};
const loading = document.getElementById('loading');

function toggleLoading(show) {
    loading.style.display = show ? 'block' : 'none';
}

function updateActiveFiltersDisplay() {
    const container = document.getElementById('active-filters-list');
    container.innerHTML = '';

    for (const [column, filter] of Object.entries(activeFilters)) {
        const filterElement = document.createElement('div');
        filterElement.className = 'active-filter-group';

        if (Array.isArray(filter)) {
            filterElement.innerHTML = `
                <div class="filter-group-header">
                    <span class="filter-column">${column}</span>
                    <button class="remove-all-btn" onclick="removeAllFilters('${column}')">Remover todos</button>
                </div>
                <div class="filter-values">
                    ${filter.map(value => `
                        <div class="filter-value-item">
                            <span title="${value}"
                                  onmouseover="showActiveFilterTooltip(event, this)"
                                  onmouseout="hideActiveFilterTooltip()">${value}</span>
                            <button class="remove-single-filter-btn" onclick="removeSingleFilter('${column}', '${value.replace(/'/g, "\\'")}')">×</button>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            let valueText = '';
            const isCurrencyFilter = column === 'Valor Deferido';

            if (isCurrencyFilter) {
                const formatOptions = {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                };

                const formattedValues = {
                    min: filter.min?.toLocaleString('pt-BR', formatOptions) || '',
                    max: filter.max?.toLocaleString('pt-BR', formatOptions) || ''
                };

                if (filter.min && filter.max) {
                    valueText = `${formattedValues.min} até ${formattedValues.max}`;
                } else if (filter.min) {
                    valueText = `A partir de ${formattedValues.min}`;
                } else if (filter.max) {
                    valueText = `Até ${formattedValues.max}`;
                }
            } else {
                if (filter.min && filter.max) {
                    valueText = `${filter.min} até ${filter.max}`;
                } else if (filter.min) {
                    valueText = `A partir de ${filter.min}`;
                } else if (filter.max) {
                    valueText = `Até ${filter.max}`;
                }
            }

            filterElement.innerHTML = `
                <div class="filter-group-header">
                    <span class="filter-column">${column}</span>
                </div>
                <div class="filter-values">
                    <div class="filter-value-item">
                        <span title="${valueText}"
                              onmouseover="showActiveFilterTooltip(event, this)"
                              onmouseout="hideActiveFilterTooltip()">${valueText}</span>
                        <button class="remove-filter-btn" onclick="removeFilter('${column}')">×</button>
                    </div>
                </div>
            `;
        }

        container.appendChild(filterElement);
    }

    if (!document.getElementById('active-filters-style')) {
        const style = document.createElement('style');
        style.id = 'active-filters-style';
        style.textContent = `
            .active-filter-group {
                margin-bottom: 12px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 4px;
                padding: 8px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .filter-group-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
                padding-bottom: 4px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            .filter-column {
                font-weight: 500;
                color: rgba(255, 255, 255, 0.9);
                font-size: 0.9em;
            }
            .filter-values {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }
            .filter-value-item {
                display: flex;
                align-items: center;
                background: rgba(255, 255, 255, 0.08);
                padding: 4px 8px;
                border-radius: 3px;
                border: 1px solid rgba(255, 255, 255, 0.15);
                max-width: 200px;
                transition: background 0.2s ease;
            }
            .filter-value-item:hover {
                background: rgba(255, 255, 255, 0.12);
            }
            .filter-value-item span {
                margin-right: 8px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                color: rgba(255, 255, 255, 0.85);
                font-size: 0.9em;
            }
            .remove-single-filter-btn, .remove-filter-btn {
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.6);
                cursor: pointer;
                padding: 0 4px;
                font-size: 14px;
                transition: color 0.2s ease;
            }
            .remove-single-filter-btn:hover, .remove-filter-btn:hover {
                color: #ff4444;
            }
            .remove-all-btn {
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.15);
                padding: 2px 8px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                color: rgba(255, 255, 255, 0.7);
                transition: all 0.2s ease;
            }
            .remove-all-btn:hover {
                background: rgba(255, 70, 70, 0.2);
                color: #ff4444;
                border-color: rgba(255, 70, 70, 0.3);
            }
        `;
        document.head.appendChild(style);
    }
}

function removeSingleFilter(column, value) {
    if (Array.isArray(activeFilters[column])) {
        activeFilters[column] = activeFilters[column].filter(v => v !== value);
        if (activeFilters[column].length === 0) {
            delete activeFilters[column];
        }
        const select = document.querySelector(`#${column.toLowerCase().replace(/\s+/g, '-')}-select`);
        if (select) {
            Array.from(select.options).forEach(option => {
                if (option.value === value) {
                    option.selected = false;
                }
            });
        }
        applyFilters();
    }
}

function removeAllFilters(column) {
    delete activeFilters[column];
    const select = document.querySelector(`#${column.toLowerCase().replace(/\s+/g, '-')}-select`);
    if (select) {
        Array.from(select.options).forEach(option => {
            option.selected = false;
        });
    }
    applyFilters();
}

function removeFilter(column) {
    delete activeFilters[column];
    const filterSection = document.querySelector(`#${column.replace(/\s+/g, '-').toLowerCase()}-filter`) ||
                         Array.from(document.querySelectorAll('.filter-section'))
                         .find(section => section.querySelector('h4')?.textContent === column);
    if (filterSection) {
        const inputs = filterSection.querySelectorAll('input');
        inputs.forEach(input => input.value = '');
        const selects = filterSection.querySelectorAll('select');
        selects.forEach(select => {
            Array.from(select.options).forEach(option => option.selected = false);
        });
    }
    applyFilters();
}

async function loadFilters() {
    try {
        toggleLoading(true);
        const container = document.getElementById('filters-container');
        container.innerHTML = '';

        // Carregar os filtros do backend
        const response = await fetch('/api/filters');
        const filters = await response.json();
        console.log("Loaded filters:", filters);

        // Adicionar o filtro de Valor Deferido
        if (filters['Valor Deferido']) {
            const valorDeferidoFilter = `
                <div class="filter-section" id="valor-deferido-filter">
                    <h4>Valor Deferido</h4>
                    <div class="filter-item">
                        <label>Valor Inicial:</label>
                        <input type="text" id="valor-deferido-min" class="currency-input" placeholder="Ex: 1.000,50">
                    </div>
                    <div class="filter-item">
                        <label>Valor Final:</label>
                        <input type="text" id="valor-deferido-max" class="currency-input" placeholder="Ex: 5.000,75">
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', valorDeferidoFilter);
        }

        // Adicionar outros filtros
        for (const [column, filter] of Object.entries(filters)) {
            if (column === 'Valor Deferido') continue; // Já adicionamos o filtro de Valor Deferido

            const filterSection = document.createElement('div');
            filterSection.className = 'filter-section';
            filterSection.id = `${column.toLowerCase().replace(/\s+/g, '-')}-filter`;

            if (filter.type === 'date') {
                filterSection.innerHTML = `
                    <h4>${column}</h4>
                    <div class="filter-item">
                        <label>Data Inicial:</label>
                        <input type="date" id="${column.toLowerCase().replace(/\s+/g, '-')}-min" min="${filter.min}" max="${filter.max}">
                    </div>
                    <div class="filter-item">
                        <label>Data Final:</label>
                        <input type="date" id="${column.toLowerCase().replace(/\s+/g, '-')}-max" min="${filter.min}" max="${filter.max}">
                    </div>
                `;
            } else if (filter.type === 'numeric') {
                filterSection.innerHTML = `
                    <h4>${column}</h4>
                    <div class="filter-item">
                        <label>Valor Inicial:</label>
                        <input type="number" id="${column.toLowerCase().replace(/\s+/g, '-')}-min" step="0.01" min="${filter.min}" max="${filter.max}">
                    </div>
                    <div class="filter-item">
                        <label>Valor Final:</label>
                        <input type="number" id="${column.toLowerCase().replace(/\s+/g, '-')}-max" step="0.01" min="${filter.min}" max="${filter.max}">
                    </div>
                `;
            } else if (filter.type === 'categorical') {
                filterSection.innerHTML = `
                    <h4>${column}</h4>
                    <div class="filter-item">
                        <input type="text" id="${column.toLowerCase().replace(/\s+/g, '-')}-search" placeholder="Pesquisar ${column}...">
                        <select multiple id="${column.toLowerCase().replace(/\s+/g, '-')}-select" size="5" style="width: 100%">
                            ${filter.values.map(value => `<option value="${value}" title="${value}">${value}</option>`).join('')}
                        </select>
                    </div>
                `;
            }
            container.appendChild(filterSection);
        }

        setupCurrencyInputs();
    } catch (error) {
        console.error('Erro ao carregar filtros:', error);
    } finally {
        toggleLoading(false);
    }
}

async function applyFilters() {
    try {
        toggleLoading(true);
        const filters = { ...activeFilters };

        // Obter valores numéricos dos inputs formatados
        const getNumericValue = (inputId) => {
            const input = document.getElementById(inputId);
            return input && input.value ? parseFloat(input.dataset.numericValue || input.value.replace(/\./g, '').replace(',', '.')) : null;
        };

        const valorDeferidoMin = getNumericValue('valor-deferido-min');
        const valorDeferidoMax = getNumericValue('valor-deferido-max');

        if (valorDeferidoMin !== null || valorDeferidoMax !== null) {
            filters['Valor Deferido'] = {
                min: valorDeferidoMin,
                max: valorDeferidoMax
            };
        }

        // Aplicar outros filtros
        const filterElements = document.querySelectorAll('.filter-section');
        filterElements.forEach(section => {
            const column = section.querySelector('h4')?.textContent.trim();
            if (!column || column === 'Valor Deferido') return;

            const minInput = section.querySelector(`#${column.toLowerCase().replace(/\s+/g, '-')}-min`);
            const maxInput = section.querySelector(`#${column.toLowerCase().replace(/\s+/g, '-')}-max`);
            const select = section.querySelector(`#${column.toLowerCase().replace(/\s+/g, '-')}-select`);

            if (minInput && maxInput) {
                const minValue = minInput.value ? (minInput.type === 'number' ? parseFloat(minInput.value) : minInput.value) : null;
                const maxValue = maxInput.value ? (maxInput.type === 'number' ? parseFloat(maxInput.value) : maxInput.value) : null;
                if (minValue || maxValue) {
                    filters[column] = { min: minValue || '', max: maxValue || '' };
                } else {
                    delete filters[column];
                }
            } else if (select) {
                const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);
                if (selectedOptions.length > 0) {
                    filters[column] = selectedOptions;
                } else {
                    delete filters[column];
                }
            }
        });

        // Enviar filtros para o backend
        const response = await fetch('/api/apply_filters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ...filters,
                page: 1,
                page_size: 100,
                sort_column: null,
                ascending: true,
                sheet_name: '{{ sheet_name }}'  // Passar o nome da planilha para o backend
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erro ao aplicar filtros:', errorText);
            alert('Erro ao aplicar filtros. Tente novamente.');
            return;
        }

        const data = await response.json();
        document.querySelector('.styled-table-container').innerHTML = data.table_html;
        activeFilters = filters;
        updateActiveFiltersDisplay();
        setupTableEvents();
    } catch (error) {
        console.error('Erro ao aplicar filtros:', error);
        alert('Ocorreu um erro ao aplicar os filtros.');
    } finally {
        toggleLoading(false);
    }
}

function resetFilters() {
    const filterElements = document.querySelectorAll('.filter-section');
    filterElements.forEach(section => {
        const minInput = section.querySelector('input[type="date"], input[type="number"]');
        const maxInput = section.querySelector('input[type="date"], input[type="number"]');
        const select = section.querySelector('select');
        const searchInput = section.querySelector('input[type="text"]');

        if (minInput && maxInput) {
            minInput.value = '';
            maxInput.value = '';
        } else if (select) {
            select.selectedIndex = -1;
        } else if (searchInput) {
            searchInput.value = '';
        }
    });

    // Limpar o conjunto de células destacadas
    highlightedCells.clear();

    // Remover o destaque de todas as células
    document.querySelectorAll('.styled-table td.highlighted').forEach(cell => {
        cell.classList.remove('highlighted');
    });

    document.getElementById('active-filters-list').innerHTML = '';
    activeFilters = {};
    applyFilters();
}

function showCopyFeedback(x, y) {
    const feedback = document.createElement('div');
    feedback.className = 'copy-feedback';
    feedback.textContent = '✓ Copiado!';
    feedback.style.left = `${x + 15}px`;
    feedback.style.top = `${y - 15}px`;
    feedback.style.display = 'block';
    document.body.appendChild(feedback);
    setTimeout(() => feedback.remove(), 2000);
}
let highlightedCells = new Set(); // Armazena os IDs das células destacadas
function setupTableEvents() {
    const headers = document.querySelectorAll('.styled-table th');
    const tooltip = document.getElementById('tooltip');
    const cells = document.querySelectorAll('.styled-table td');

    headers.forEach(header => {
        header.addEventListener('click', async function() {
            const column = this.textContent.trim();
            let ascending = activeFilters.ascending !== false;
            activeFilters.ascending = !ascending;

            try {
                toggleLoading(true);
                const response = await fetch('/api/apply_filters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...activeFilters,
                        sort_column: column,
                        ascending: ascending
                    })
                });

                const data = await response.json();
                document.querySelector('.styled-table-container').innerHTML = data.table_html;
                setupTableEvents();
                addCopyButtons();

                // Reaplicar os destaques após recarregar a tabela
                reapplyHighlights();
            } catch (error) {
                console.error('Erro ao ordenar tabela:', error);
            } finally {
                toggleLoading(false);
            }
        });
    });
function reapplyHighlights() {
    highlightedCells.forEach(cellId => {
        const cell = document.getElementById(cellId);
        if (cell) {
            cell.classList.add('highlighted');
        }
    });
}
    let targetColumnIndex = -1;
    headers.forEach((header, index) => {
        if (header.textContent.trim().toLowerCase() === 'autos do precatório') {
            targetColumnIndex = index;
        }
    });

    if (targetColumnIndex !== -1) {
        const rows = document.querySelectorAll('.styled-table tbody tr');
        rows.forEach((row, rowIndex) => {
            const targetCell = row.cells[targetColumnIndex];
            if (targetCell) {
                const cellId = `row-${rowIndex}-col-${targetColumnIndex}`; // ID único para a célula
                targetCell.id = cellId; // Atribuir um ID à célula
                targetCell.style.cursor = 'pointer';
                targetCell.title = 'Clique para copiar';
                targetCell.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const textToCopy = this.textContent.trim();
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showCopyFeedback(e.clientX, e.clientY);

                        // Alternar o destaque da célula
                        if (this.classList.contains('highlighted')) {
                            this.classList.remove('highlighted'); // Remove o destaque
                            highlightedCells.delete(cellId); // Remove o ID da célula do conjunto
                        } else {
                            this.classList.add('highlighted'); // Adiciona o destaque
                            highlightedCells.add(cellId); // Adiciona o ID da célula ao conjunto
                        }
                    }).catch(err => {
                        console.error('Erro ao copiar:', err);
                    });
                });

                // Reaplicar o destaque se a célula estiver no conjunto
                if (highlightedCells.has(cellId)) {
                    targetCell.classList.add('highlighted');
                }
            }
        });
    }

    cells.forEach(cell => {
        cell.addEventListener('mouseover', function(event) {
            const fullText = this.textContent;
            if (fullText) {
                tooltip.textContent = fullText;
                tooltip.style.display = 'block';
                const cellRect = this.getBoundingClientRect();
                const tooltipTop = cellRect.bottom + window.scrollY;
                const tooltipLeft = cellRect.left + window.scrollX;
                tooltip.style.top = `${tooltipTop}px`;
                tooltip.style.left = `${tooltipLeft}px`;
            }
        });

        cell.addEventListener('mouseout', function() {
            tooltip.style.display = 'none';
        });
    });
}

function addCopyButtons() {
    const table = document.getElementById('dynamic-table');
    const cells = table.querySelectorAll('td');
    cells.forEach(cell => {
        const copyButton = document.createElement('button');
        copyButton.innerText = '📋 Copiar';
        copyButton.className = 'copy-button';
        copyButton.addEventListener('click', (event) => {
            event.stopPropagation();
            const textToCopy = cell.innerText.trim();
            navigator.clipboard.writeText(textToCopy).then(() => {
                copyButton.innerText = '✓ Copiado!';
                setTimeout(() => copyButton.innerText = '📋 Copiar', 1500);
            }).catch(err => {
                console.error('Falha ao copiar texto: ', err);
                alert('Não foi possível copiar o texto');
            });
        });
        cell.style.position = 'relative';
        cell.appendChild(copyButton);
    });
}

function goToPage(page) {
    const filters = { ...activeFilters };
    const url = new URL(window.location.href);
    url.searchParams.set('page', page);
    url.searchParams.set('filters', JSON.stringify(filters));
    window.location.href = url.toString();
}

document.addEventListener('click', function(event) {
    if (!event.target.closest('.styled-table td')) {
        document.getElementById('tooltip').style.display = 'none';
    }
});

document.addEventListener('DOMContentLoaded', function() {
    loadFilters();
    setupTableEvents();
    setupCurrencyInputs();
    const tooltip = document.createElement("div");
    tooltip.classList.add("tooltip");
    document.body.appendChild(tooltip);

    document.querySelectorAll("td:nth-child(2)").forEach(cell => {
        cell.style.cursor = "pointer";
        cell.addEventListener("click", function(event) {
            let textToCopy = this.textContent.trim();
            navigator.clipboard.writeText(textToCopy).then(() => {
                tooltip.textContent = "Copiado!";
                tooltip.style.left = `${event.pageX + 10}px`;
                tooltip.style.top = `${event.pageY}px`;
                tooltip.style.display = "block";
                setTimeout(() => tooltip.style.display = "none", 1000);
            }).catch(err => console.error("Erro ao copiar: ", err));
        });
    });

    document.getElementById('pageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            goToPage(this.value);
        }
    });
});

// Funções para tooltip dos filtros ativos
function showActiveFilterTooltip(event, element) {
    const tooltip = document.getElementById('tooltip');
    tooltip.textContent = element.title;
    tooltip.style.display = 'block';
    tooltip.style.left = `${event.pageX + 10}px`;
    tooltip.style.top = `${event.pageY + 10}px`;
}

function hideActiveFilterTooltip() {
    document.getElementById('tooltip').style.display = 'none';
}

    </script>
</body>
</html>
